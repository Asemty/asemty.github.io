<canvas id="gc" width="800" height="600"></canvas>
<script>
window.onload=function() {
    canv=document.getElementById("gc");
    ctx=canv.getContext("2d");
    document.addEventListener("keydown",keyPress);
	document.addEventListener("keyup",keyRelease);
	start();
    setInterval(update,1000/45);
}

GRAVITY=1;
UI_ELEMENT_SIZE=12;
CAM_X_OFFSET=260;
CAM_Y_OFFSET=200;

PLAYER_MAX_JUMP=3;
PLAYER_JUMP_HEIGHT=16;
PLAYER_SPEED=12;
PLAYER_MAX_DASH=24;
PLAYER_MAX_ATTACK=16;
PLAYER_MAX_HP=3;
PLAYER_MAX_HURTTIME=90;

SWORD_BLOCK_SIZE=12;
SWORD_BLOCK_NUMBER=6;
SWORD_BLOCK_OFFSET=0;
SWORD_ANGLE_START=-Math.PI/2;
SWORD_ANGLE_FINISH=Math.PI/2;
SWORD_ANGLE_STEP=-(SWORD_ANGLE_START-SWORD_ANGLE_FINISH)/PLAYER_MAX_ATTACK;


class Actor{
	constructor(x,y,w,h){
		this.x=x;
		this.y=y;
		this.width=w;
		this.height=h;
		this.active=true;
		this.solid=false;
		this.activeOutScreen=false;
	}
	update(){}
	draw(){}
	colusionToActorCheck(actor){
		return this.x-1<actor.x+actor.width && this.x+this.width+1>actor.x && this.y-1<actor.y+actor.height && this.y+this.height+1>actor.y;
	}
	solidColusionCheck(x,y,w,h){
		return this.x<x+w && this.x+this.width>x && this.y<y+h && this.y+this.height>y;
	}
	colusionCheck(x,y,w,h){
		return this.x-1<x+w && this.x+this.width+1>x && this.y-1<y+h && this.y+this.height+1>y;
	}
}
class MovableActor extends Actor{
	constructor(x,y,w,h){
		super(x,y,w,h);
		this.vs=0;
		this.hs=0;
		this.canFall=false;
	}
	update(){
		super.update();
		var isColide=false;
		for(var i=0;i<stage.actors.length;i++){
			if(stage.actors[i].solid && this.solidColusionCheck(stage.actors[i].x-this.hs,stage.actors[i].y-this.vs,stage.actors[i].width,stage.actors[i].height)){
				isColide=true;
				break;
			}
		}
		if(!isColide){
			this.x+=this.hs;
			this.y+=this.vs;
		}else{
			var j=0;
			var dir=Math.sign(this.hs);
			var lng=Math.abs(this.hs);
			for(i=0;i<lng;i++){
				for(j=0;j<stage.actors.length;j++){
					if(stage.actors[j].solid && this.solidColusionCheck(stage.actors[j].x-dir*i,stage.actors[j].y,stage.actors[j].width,stage.actors[j].height)){
						break;
					}
				}
				if(j<stage.actors.length){
					this.hs=0;
					break;
				}
			}
			this.x+=dir*(i-1);
			
			dir=Math.sign(this.vs);
			lng=Math.abs(this.vs);
			for(i=0;i<lng;i++){
				for(j=0;j<stage.actors.length;j++){
					if(stage.actors[j].solid && this.solidColusionCheck(stage.actors[j].x,stage.actors[j].y-dir*i,stage.actors[j].width,stage.actors[j].height)){
						break;
					}
				}
				if(j<stage.actors.length){
					this.vs=0;
					break;
				}
			}
			this.y+=dir*(i-1);
		}
		if(this.canFall){
			this.vs+=GRAVITY;
		}
	}
}
class Player extends MovableActor{
	constructor(x,y,w,h){
		super(x,y,w,h);
		
		this.canFall=true;
		this.dashTimer=0;
		//this.attackTimer=0;
		this.playerJump=PLAYER_MAX_JUMP;
		this.leftDirection=false;
		this.activeOutScreen=true;
		this.onGround=false;
		this.isDead=false;
		this.hurtTimer=0;
		this.itemIndex=0;
		this.items=[];
		this.items.push(new Sword());
	}
	update(){
		super.update();
		this.cameraUpdate();
		if(this.y-this.height*2>stage.height){this.dead();}
		if(this.dashTimer==0){
			this.hs=((left?-1:0)+(right?1:0))*PLAYER_SPEED;
		}else{
			this.dashTimer-=Math.sign(this.dashTimer);
			this.hs=Math.sign(this.dashTimer)*PLAYER_SPEED*2;
			this.vs=0;
		}
		this.items[this.itemIndex].update();
		if(this.hurtTimer>0){
			this.hurtTimer--;
		}
		var isColide=false;
		for(var i=0;i<stage.actors.length;i++){
			if(stage.actors[i].solid && this.solidColusionCheck(stage.actors[i].x,stage.actors[i].y-1,stage.actors[i].width,stage.actors[i].height)){
				isColide=true;
				break;
			}
		}
		if(isColide){
			this.playerJump=PLAYER_MAX_JUMP;
		}
		this.onGround=isColide;
	}
	cameraUpdate(){
		if(this.x+this.width-cam.x>canv.width-CAM_X_OFFSET){
			cam.x=Math.min(stage.width-canv.width,this.x+this.width-canv.width+CAM_X_OFFSET);
		}
		if(this.x-cam.x<CAM_X_OFFSET){
			cam.x=Math.max(0,this.x-CAM_X_OFFSET);
		}
		if(this.y+this.height-cam.y>canv.height-CAM_Y_OFFSET){
			cam.y=Math.min(stage.height-canv.height,this.y+this.height-canv.height+CAM_Y_OFFSET);
		}
		if(this.y-cam.y<CAM_Y_OFFSET){
			cam.y=Math.max(0,this.y-CAM_Y_OFFSET);
		}
	}
	draw(){
		ctx.fillStyle=this.dashTimer==0?(this.hurtTimer%6<3?"black":"darkgray"):"darkgray";
		fillRect(this.x,this.y,this.width,this.height);
	
		ctx.fillStyle=this.dashTimer==0?"white":"red";
		fillRect(this.x+this.width/12*(this.leftDirection?1:6),this.y+this.height/5,this.width/12*5,this.height/5);
		
		this.items[this.itemIndex].draw();
	}
	
	
	dash(direct){
		if(this.playerJump>0 && this.dashTimer==0 && this.items[this.itemIndex].attackTimer==0){
			this.dashTimer=PLAYER_MAX_DASH*direct;
			this.playerJump--;
		}
	}
	attack(){
		this.items[this.itemIndex].use();
	}
	hurt(){
		if(this.hurtTimer==0){
			this.hurtTimer=PLAYER_MAX_HURTTIME;
			hp--;
			if(hp<1){
				this.dead();
			}
		}
	}
	jump(){
		if(this.playerJump>0 && this.dashTimer==0){
				this.vs=-PLAYER_JUMP_HEIGHT;
				this.playerJump--;
			}
	}
	dead(){
		this.isDead=true;
		this.active=false;
	}
	colide(actor){
		if(actor instanceof HotBlock){
			if(this.hurtTimer==0)this.hurt();
		}else if(actor instanceof DoorBlock){
			stage=new actor.stage(actor.position);
		}else if(actor instanceof CheckBlock){
			checkPoint.stg=stage;
			checkPoint.pos=actor.position;
			hp=PLAYER_MAX_HP;
		}
	}
}
class SolidBlock extends Actor{
	constructor(x,y,w,h){
		super(x,y,w,h);
		this.solid=true;
	}
	update(){
	}
	draw(){
		ctx.fillStyle="black";
		fillRect(this.x,this.y,this.width,this.height);
	}
}
class HotBlock extends Actor{
	constructor(x,y,w,h){
		super(x,y,w,h);
	}
	get solid(){
		return player.dashTimer==0 && this.sld;
	}
	set solid(value){
		this.sld=true;
	}
	update(){
	}
	draw(){
		ctx.fillStyle="red";
		fillRect(this.x,this.y,this.width,this.height);
	}
}
class DoorBlock extends Actor{
	constructor(x,y,w,h,s,p){
		super(x,y,w,h);
		this.stage=s;
		this.position=p;
	}
	update(){
	}
	draw(){
		ctx.fillStyle="blue";
		fillRect(this.x,this.y,this.width,this.height);
	}
}
class CheckBlock extends Actor{
	constructor(x,y,w,h,p){
		super(x,y,w,h);
		this.position=p;
	}
	update(){
	}
	draw(){
		ctx.fillStyle="yellow";
		fillRect(this.x,this.y,this.width,this.height);
	}
}
class Item extends Actor{
	constructor(x,y,w,h){
		super(x,y,w,h)
		this.attackTimer=0;
	}
}
class Sword extends Item{
	constructor(){
		super(0,0,32,48)
	}
	update(){
		if(this.attackTimer==0){
			if(player.hs<0)player.leftDirection=true;
			if(player.hs>0)player.leftDirection=false;
		}
		if(this.attackTimer>0){
			this.attackTimer--;
			player.hs+=PLAYER_SPEED/2*(player.leftDirection?-1:1);
		}
	}
	use(){
			if(player.dashTimer==0 && this.attackTimer==0){
				this.attackTimer=PLAYER_MAX_ATTACK;
			}
			
		}
	draw(){
		if(this.attackTimer!=0){
			ctx.fillStyle="red";
			for(var i=0;i<SWORD_BLOCK_NUMBER;i++){
				this.drawSwordLine("#ffaaaa",2,i);
				this.drawSwordLine("#ff5555",1,i);
				this.drawSwordLine("red",0,i);
			}
		}
	}
	drawSwordLine(color,ping,box){
		ctx.fillStyle=color;		
		fillRect(
					player.x+player.width/2+(SWORD_BLOCK_SIZE+SWORD_BLOCK_OFFSET)*(box+2)
						*Math.cos(SWORD_ANGLE_FINISH-SWORD_ANGLE_STEP*(this.attackTimer+box/2+ping))*(player.leftDirection?-1:1),
					player.y+player.height/2+(SWORD_BLOCK_SIZE+SWORD_BLOCK_OFFSET)*(box+2)
						*Math.sin(SWORD_ANGLE_FINISH-SWORD_ANGLE_STEP*(this.attackTimer+box/2+ping)),
					SWORD_BLOCK_SIZE,
					SWORD_BLOCK_SIZE);
	}
}
class Stage{
	constructor(w,h){
		this.actors=[];
		if(w!=null && h!=null){
			this.width=w;
			this.height=h;
		}else{
			this.width=canv.width;	
			this.height=canv.height;
		}
		
	}
	update(){
		for(var i=0;i<this.actors.length;i++){
			if(this.actors[i].active && (this.actors[i].activeOutScreen || this.actors[i].x+this.actors[i].width>cam.x && this.actors[i].x<cam.x+canv.width && this.actors[i].y+this.actors[i].height>cam.y && this.actors[i].y<cam.y+canv.height)){
				this.actors[i].update();
				if(this.actors[i].colide!=null){
					for(var j=0;j<this.actors.length;j++){
						if(i!=j && this.actors[i].colusionToActorCheck(this.actors[j])){
							this.actors[i].colide(this.actors[j]);
						}
					}
				}
			}
			
		}
	}
	draw(){
		for(var i=0;i<this.actors.length;i++){
			if(this.actors[i].active && this.actors[i].x+this.actors[i].width>cam.x && this.actors[i].x<cam.x+canv.width && this.actors[i].y+this.actors[i].height>cam.y && this.actors[i].y<cam.y+canv.height){
				this.actors[i].draw();
			}
		}
	}
}

class Stage1 extends Stage{
	constructor(playerPosition){
		super();
		switch(playerPosition){
			case 0:
				var px=48,py=504;
				break;
			case 1:
				var px=752,py=504;
				break;
		}
		player = new Player(px,py,32,48);
		this.actors.push(player);
		
		this.actors.push(new SolidBlock(0,0,800,48));
		this.actors.push(new SolidBlock(0,0,48,600));
		this.actors.push(new SolidBlock(0,552,800,48));
		this.actors.push(new SolidBlock(752,0,48,456));
		this.actors.push(new SolidBlock(552,300,48,48));
		this.actors.push(new SolidBlock(656,150,96,48));
		
		this.actors.push(new HotBlock(464,158,192,32));
		
		this.actors.push(new DoorBlock(828,456,48,96,Stage2,0));
	}
	draw(){
		super.draw();
		ctx.font = "36px Arial";
		ctx.fillStyle="blue";
		ctx.fillText("J-Jump",50,140);
		ctx.fillText("H-Attack",50,180);
		ctx.fillText("A,D-Walk",50,220);
		ctx.fillText("AA,DD-Dash",50,260);
	}
}
class Stage2 extends Stage{
	constructor(playerPosition){
		super();
		switch(playerPosition){
			case 0:
				var px=0,py=504;
				break;
			case 1:
				var px=752,py=144;
				break;
			case 2:
				var px=704,py=456;
				break;
		}
		player = new Player(px,py,32,48);
		this.actors.push(player);
		
		this.actors.push(new SolidBlock(0,0,800,48));
		this.actors.push(new SolidBlock(0,0,48,456));
		this.actors.push(new SolidBlock(0,552,800,48));
		this.actors.push(new SolidBlock(752,152,48,422));
		this.actors.push(new SolidBlock(160,152,48,48));
		this.actors.push(new SolidBlock(160,352,48,48));
		this.actors.push(new SolidBlock(160,504,48,48));
		this.actors.push(new SolidBlock(320,278,48,48));
		this.actors.push(new SolidBlock(480,152,48,48));
		this.actors.push(new SolidBlock(480,352,48,48));
		this.actors.push(new SolidBlock(600,152,160,48));
		this.actors.push(new SolidBlock(680,504,80,48));
		
		this.actors.push(new HotBlock(168,400,32,104));
		this.actors.push(new HotBlock(168,48,32,104));
		this.actors.push(new HotBlock(488,48,32,104));
		this.actors.push(new HotBlock(488,400,32,112));
		this.actors.push(new HotBlock(640,278,40,234));
		this.actors.push(new HotBlock(328,48,32,230));
		this.actors.push(new HotBlock(208,512,472,40));
		
		this.actors.push(new DoorBlock(-76,456,48,96,Stage1,1));
		
		this.actors.push(new CheckBlock(690,498,60,6,2));
	}
}

buttonTiming=15;
left=false;
leftTiming=0;
right=false;
rightTiming=0;
cam={x: 0,y: 0}
checkPoint={stg: NaN,pos: 0}
player=NaN;
hp=PLAYER_MAX_HP;

function start(){
	stage = new Stage1(0);
	checkPoint.stg=stage;
	checkPoint.pos=0;
}
function loadCheckpoint(){
	stage = new checkPoint.stg.constructor(checkPoint.pos);
	hp=PLAYER_MAX_HP;
}
function fillRect(x,y,w,h){
	ctx.fillRect(x-cam.x,y-cam.y,w,h);
}

function update() {
	stage.update();
	draw();
	if(leftTiming>0){
		leftTiming--;
	}
	if(rightTiming>0){
		rightTiming--;
	}
}
function draw(){
	ctx.fillStyle="#eeeeee";
    ctx.fillRect(0,0,canv.width,canv.height);
	stage.draw();
	drawUI();
}
function drawUI(){
	for(i=0;i<PLAYER_MAX_HP;i++){
			if(i<hp){
				ctx.fillStyle="red";
			}else{
				ctx.fillStyle="darkred";
			}
			ctx.fillRect(UI_ELEMENT_SIZE+UI_ELEMENT_SIZE*i*1.5,UI_ELEMENT_SIZE,UI_ELEMENT_SIZE,UI_ELEMENT_SIZE);
		}
	for(i=0;i<PLAYER_MAX_JUMP;i++){
			if(i<player.playerJump){
				ctx.fillStyle="lime";
			}else{
				ctx.fillStyle="green";
			}
			ctx.fillRect(UI_ELEMENT_SIZE+UI_ELEMENT_SIZE*i*1.5,UI_ELEMENT_SIZE*2.3,UI_ELEMENT_SIZE,UI_ELEMENT_SIZE);
		}
	if(player.isDead){
		ctx.font = "58px Arial";
		ctx.fillStyle="red";
		ctx.fillText("Press \"SPACE\" to respawn",30,100);
	}
}
function keyPress(evt) {
    switch(evt.keyCode) {
        case 74:
			player.jump();
            break;
		case 83:
            break;
		case 65:
			if(left==false){
				left=true;
				if(leftTiming==0){
					leftTiming=buttonTiming;
				}else{
					player.dash(-1);
				}
			}
            break;
		case 68:
			if(right==false){
				right=true;
				if(rightTiming==0){
					rightTiming=buttonTiming;
				}else{
					player.dash(1);
				}
			}
            break;
		case 72:
			player.attack()
			break;
		case 32:
			loadCheckpoint();
			break;
    }
}
function keyRelease(evt) {
    switch(evt.keyCode) {
		case 65:
			left=false;
			if(player.dashTimer<0){player.dashTimer=0;}
            break;
		case 68:
			right=false;
			if(player.dashTimer>0){player.dashTimer=0;}
            break;
    }
}
</script>